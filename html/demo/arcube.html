<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=1">
    <link rel="stylesheet" href="style.css">
    <title>temp</title>
</head>

<body>
    <video id="video" playsInline muted autoplay></video>
    <canvas id="canvas"></canvas>
    <div id="message">loading...</div>
    <div class="page-content" style="display: none;">
        <label>scalar:<input id="scalar" type="range" min="-10" max="10" value="0" /></label>
        <div class="block-title">animation</div>
        <div class="list simple-list" id="animationblock">
            <ul></ul>
        </div>
    </div>
    <script src="/demo/jquery.min.js"></script>
    <script src="/demo/three.js/three.min.js"></script>
    <script src="/demo/three.js/js/controls/OrbitControls.js"></script>
    <script src="/demo/three.js/js/loaders/GLTFLoader.js"></script>
    <script src="/demo/three.js/js/libs/fflate.min.js"></script>
    <script src="/demo/three.js/js/loaders/FBXLoader.js"></script>
    <script src="/build/artoolkit_wasm.js"></script>
    <script src="/qrcode/zxing-js/zxing-browser.min.js"></script>
    <script>
        var markerNumber;
        var video = document.getElementById('video');
        var codeReader;
        var arController;
        //
        var canvas = document.getElementById('canvas');
        let camera, scene, renderer;
        let geometry, material, mesh;
        var model;
    </script>
    <script src="temp.js"></script>
    <script>
        function initQrcode() {
            codeReader = new ZXingBrowser.BrowserMultiFormatReader();
            codeReader.decodeFromVideoElement(video, (result, error, controls) => {
                if (result) {
                    log("QRCODE", result.text);
                }
            });
            log('init', 'Qrcode');
        }
        function initArtoolkit() {
            var profile = '/examples/Data/camera_para-iPhone 5 rear 640x480 1.0m.dat';
            var cameraParam = new ARCameraParam(profile);
            cameraParam.onload = function () {
                arController = new ARController(video, cameraParam);

                // window.onorientationchange = function (e) {
                //     orientationChange();
                // }

                // orientationChange();

                arController.addEventListener('getMarker', function (ev) {
                    getMarker(ev);
                });

                arController.addEventListener('getNFTMarker', function (ev) {
                    getMarker(ev);
                });

                arController.setPatternDetectionMode(artoolkit.AR_TEMPLATE_MATCHING_COLOR_AND_MATRIX);
                arController.setMatrixCodeType(artoolkit.AR_MATRIX_CODE_3x3);

                // arController.loadMarker('/examples/Data/patt.kanji', function (markerId) {
                // });

                //var list = [];
                //78
                // for (var i = 1; i < 2; i++) {
                //     list.push('/DATANFT/' + i);
                // }
                // arController.loadNFTMarkers(list, function (markerIds) {
                //     log('NFT Marker Count', markerIds.length);
                // });
                log('init', 'ARToolkit');
                var tick = function () {
                    arController.process();
                    requestAnimationFrame(tick);
                };
                tick();
            };
        }

        function initThreejs() {


            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setClearColor(0x000000, 0);
            renderer.setSize(canvas.width, window.height);

            camera = new THREE.PerspectiveCamera(70, canvas.width / canvas.height, 0.01, 10);
            camera.position.z = 1;

            scene = new THREE.Scene();

            var light = new THREE.PointLight(0xffffff);
            light.position.set(400, 500, 100);
            scene.add(light);
            var light = new THREE.PointLight(0xffffff);
            light.position.set(-400, -500, -100);
            scene.add(light);

            var markerRoot = new THREE.Object3D();
            model = markerRoot;
            markerRoot.wasVisible = false;
            markerRoot.markerMatrix = new Float64Array(12);
            markerRoot.matrixAutoUpdate = false;
            camera.matrixAutoUpdate = false;

            var mesh = new THREE.Mesh(
                new THREE.BoxGeometry(1, 1, 1),
                new THREE.MeshNormalMaterial()
            );
            markerRoot.add(mesh);
            scene.add(markerRoot);

            renderer.setAnimationLoop(animation);
        }

        function animation(time) {
            renderer.render(scene, camera);
        }

        function init() {
            initQrcode();
            initArtoolkit();
            initThreejs();
        }

        function getModel(number) {
            return model;
        }
        function getMarker(ev) {
            var markerType = ev.data.type;
            var currentMarkerId;
            if (markerType === artoolkit.PATTERN_MARKER) {
                currentMarkerId = ev.data.marker.idPatt;
                log("Pattern", markerId);
            } else if (markerType === artoolkit.BARCODE_MARKER) {
                currentMarkerId = ev.data.marker.idMatrix;
                log("Barcode", ev.data.marker.idMatrix);
            }
            else if (markerType == artoolkit.NFT_MARKER) {
                currentMarkerId = ev.data.marker.id;
                log("NFT", ev.data.marker.id);
            }
            var lost = false;

            if (ev.data.type > 0) {
                var currentMarkerNumber = currentMarkerId * 10000000 + currentMarkerId;
                console.log('Marker:' + currentMarkerNumber);
                if (!markerNumber) {
                    var model = getModel(currentMarkerNumber);
                    if (model) {
                        markerNumber = currentMarkerNumber;
                        model.visible = true;
                        setProjectionMatrix(model.matrix, ev.data.matrixGL_RH);
                    }
                }
                else {
                    if (currentMarkerNumber === markerNumber) {
                        var model = getModel(currentMarkerNumber);
                        if (model) {
                            setProjectionMatrix(model.matrix, ev.data.matrixGL_RH);
                        }
                        //var model = getModel(currentMarkerNumber);
                    }
                    else {
                        //var model = getModel(markerNumber);
                        //model.destory()
                        //var model = getModel(currentMarkerNumber);
                        //model.positon = ev.xx
                        markerNumber = null;
                        var model = getModel(currentMarkerNumber);
                        model.visible = false;
                        markerNumber = currentMarkerNumber;
                        var model = getModel(currentMarkerNumber);
                        model.visible = true;
                    }
                }

            }
            else {//lost marker
                if (markerNumber) {
                    var model = getModel(markerNumber);
                    if (model) {
                        markerNumber = null;
                        //model.destory()
                        model.visible = false;
                    }
                }
            }
        }

        function success(stream) {
            video.srcObject = stream;
            video.onloadedmetadata = function (e) {
                console.log('video.onloadedmetadata');
                video.width = e.srcElement.videoWidth;
                video.height = e.srcElement.videoHeight;
                canvas.width = video.width;
                canvas.height = video.height;
                window.onresize = function (e) {
                    resize(video, canvas);
                }
                resize(video, canvas);
                setTimeout(() => {
                    init();
                }, 0);
            };
            video.play();
            console.log('video.play');
        }

        function setProjectionMatrix(projectionMatrix, value) {
            if (typeof projectionMatrix.elements.set === "function") {
                projectionMatrix.elements.set(value);
            } else {
                projectionMatrix.elements = [].slice.call(value);
            }
        };
    </script>
    <script>
        var width = 640;
        var height = 480;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        var hdConstraints = {
            audio: false,
            video: {
                width: { ideal: width },
                height: { ideal: height },
            }
        };

        if (isMobile()) {
            hdConstraints.video.facingMode = { "exact": "environment" };
        }
        else {
            document.body.className = "desktop";
        }

        if (navigator.getUserMedia) {
            navigator.getUserMedia(hdConstraints, success, errorCallback);
        } else {
            errorCallback('');
        }
    </script>
</body>

</html>